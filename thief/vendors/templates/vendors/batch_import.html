{% extends 'foundation.html' %}
{% block title %}上傳產品清單{% endblock title %}
{% block main %}
<h3>上傳產品清單</h3>
<hr />
<div class="container" {% if data%}style="display: none"{% endif %}>
  <form method="post" class="form-horizontal" enctype="multipart/form-data" role="form">{% csrf_token %}
    <div class="form-group">
      <label class="col-sm-2 control-label">上傳檔案</label>
      <div class="col-sm-10">
        <div class="checkbox">
          <input type="file" name="csv_file" />
        </div>
      </div>
    </div>
    <div class="form-group">
      <div class="col-sm-10 col-sm-offset-2">
        <button class="btn btn-primary">上傳</button>
      </div>
    </div>
  </form>
</div>

{% if data %}
<div class="alert alert-warning">注意：開始批次上傳後關閉本頁面將會中斷批次上傳作業</div>
<table class="table table-striped">
  <thead>
    <tr><th>型號</th><th>品項</th><th>價格</th><th style="width: 100px"></th></tr>
  </thead>
  <tbody>
    {% for r in data %}
      <tr data-role="item" data-type="{{ r.t }}" data-group="{{ r.g }}" data-price="{{ r.p }}"><td>{{ r.t }}</td><td>{{ r.g }}</td><td>{{ r.p }}</td><td data-role="st"></td></tr>
    {% endfor %}
  </tbody>
</table>
<div class="container">
  <div class="row">
    <div class="col-sm-1 col-sm-offset-11">
      <button class="btn btn-sm btn-success" data-role="go">開始</button>
    </div>
  </div>
</div>

<form style="display: none;" method="post" id="create_form">{% csrf_token %}
  <input type="hidden" name="model_id" />
  <input type="hidden" name="group" />
  <input type="hidden" name="price" />
</form>
<script type="text/javascript">
$(function() {
  function make_request(model_id, group, price, $element) {
    var $f = $("form#create_form");
    $("[name=model_id]", $f).val(model_id);
    $("[name=group]", $f).val(group);
    $("[name=price]", $f).val(price);

    $("[data-role=st]", $element).text("處理中...");
    $.ajax("{% url 'vendor_import_item' 'json' %}", {type: "post", dataType:"json",
      data: $f.serialize(), success: function(result) {
        if(result.st)
          $("[data-role=st]", $element)
            .text("")
            .append($("<span>OK</span>"))
            .append($("<a>檢視</a>").attr('href', result.url));
      }, error: function() {
        $("[data-role=st]", $element).text("系統錯誤")
      }
    });
  }
  
  function working_thread($rows, index) {
    if(index >= $rows.length) return;
    
    var $row = $($rows[index]);
    make_request($row.attr("data-type"), $row.attr("data-group"), $row.attr("data-price"), $row);
    
    setTimeout(function() {
      working_thread($rows, index + 1);
    }, 60000);
    var $new_row = $rows[index + 1];
    $("[data-role=st]", $new_row).text("60秒後開始...");
  }
  
  $("button[data-role=go]").bind("click", function() {
    $(this).hide();
    
    var $rows = $("[data-role=item]");
    $("[data-role=st]", $rows).text("等待中");
    working_thread($rows, 0);
  });
});
</script>
{% endif %}
{% endblock %}